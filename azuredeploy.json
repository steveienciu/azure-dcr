{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "metadata": {
        "description": "Region for the Data Collection Rule."
      }
    },
    "workspaceResourceGroup": {
      "type": "string",
      "metadata": {
        "description": "Resource group containing the Log Analytics workspace."
      }
    },
    "workspaceName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Log Analytics workspace that will receive the data."
      }
    },
    "deployWindowsDcr": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "When true, deploys the Windows Event Logs Data Collection Rule."
      }
    },
    "windowsDcrName": {
      "type": "string",
      "defaultValue": "bv-windows-security-event-dcr",
      "metadata": {
        "description": "Name of the Windows Event Logs DCR."
      }
    },
    "deploySystemAppDcr": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "When true, deploys the System and Application logs DCR."
      }
    },
    "systemAppDcrName": {
      "type": "string",
      "defaultValue": "bv-windows-system-application-dcr",
      "metadata": {
        "description": "Name of the System and Application logs DCR."
      }
    },
    "deploySyslogDcr": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "When true, deploys the syslog DCR for unmanaged collectors."
      }
    },
    "syslogDcrName": {
      "type": "string",
      "defaultValue": "bv-syslog-dcr",
      "metadata": {
        "description": "Name of the syslog DCR."
      }
    },
    "deployCefDcr": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "When true, deploys the CEF DCR for unmanaged collectors."
      }
    },
    "cefDcrName": {
      "type": "string",
      "defaultValue": "bv-cef-dcr",
      "metadata": {
        "description": "Name of the CEF DCR."
      }
    },
    "deployCiscoDcr": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Reserved for future Cisco DCR deployment."
      }
    },
    "ciscoDcrName": {
      "type": "string",
      "defaultValue": "bv-cisco-dcr",
      "metadata": {
        "description": "Name for the Cisco DCR (for future use)."
      }
    },
    "deployManagedSyslogDcr": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "When true, deploys the managed syslog DCR."
      }
    },
    "managedSyslogDcrName": {
      "type": "string",
      "defaultValue": "bv-syslog-dcr",
      "metadata": {
        "description": "Name of the managed syslog DCR."
      }
    },
    "deployManagedCefDcr": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "When true, deploys the managed CEF DCR."
      }
    },
    "managedCefDcrName": {
      "type": "string",
      "defaultValue": "bv-cef-dcr",
      "metadata": {
        "description": "Name of the managed CEF DCR."
      }
    },
    "deployManagedCiscoDcr": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "When true, deploys the managed Cisco DCR."
      }
    },
    "managedCiscoDcrName": {
      "type": "string",
      "defaultValue": "bv-cisco-dcr",
      "metadata": {
        "description": "Name of the managed Cisco DCR."
      }
    }
  },
  "variables": {
    "workspaceResourceId": "[resourceId(parameters('workspaceResourceGroup'), 'Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]",
    "effectiveWindowsDcrName": "[if(equals(parameters('windowsDcrName'), ''), 'bv-windows-security-event-dcr', parameters('windowsDcrName'))]",
    "effectiveSystemAppDcrName": "[if(equals(parameters('systemAppDcrName'), ''), 'bv-windows-system-application-dcr', parameters('systemAppDcrName'))]",
    "effectiveSyslogDcrName": "[if(equals(parameters('syslogDcrName'), ''), 'bv-syslog-dcr', parameters('syslogDcrName'))]",
    "effectiveCefDcrName": "[if(equals(parameters('cefDcrName'), ''), 'bv-cef-dcr', parameters('cefDcrName'))]",
    "effectiveCiscoDcrName": "[if(equals(parameters('ciscoDcrName'), ''), 'bv-cisco-dcr', parameters('ciscoDcrName'))]",
    "effectiveManagedSyslogDcrName": "[if(equals(parameters('managedSyslogDcrName'), ''), 'bv-syslog-dcr', parameters('managedSyslogDcrName'))]",
    "effectiveManagedCefDcrName": "[if(equals(parameters('managedCefDcrName'), ''), 'bv-cef-dcr', parameters('managedCefDcrName'))]",
    "effectiveManagedCiscoDcrName": "[if(equals(parameters('managedCiscoDcrName'), ''), 'bv-cisco-dcr', parameters('managedCiscoDcrName'))]"
  },
  "resources": [
    {
      "condition": "[parameters('deployWindowsDcr')]",
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2022-06-01",
      "name": "[variables('effectiveWindowsDcrName')]",
      "location": "[parameters('location')]",
      "kind": "Windows",
      "tags": {
        "createdBy": "DCR-Deployment"
      },
      "properties": {
        "dataSources": {
          "windowsEventLogs": [
            {
              "name": "eventLogsDataSource",
              "scheduledTransferPeriod": "PT5M",
              "streams": [
                "Microsoft-SecurityEvent"
              ],
              "xPathQueries": [
                "Security!*[System[(EventID=1) or (EventID=299) or (EventID=300) or (EventID=324) or (EventID=340) or (EventID=403) or (EventID=404) or (EventID=410) or (EventID=411) or (EventID=412) or (EventID=413) or (EventID=431) or (EventID=500) or (EventID=501) or (EventID=1100)]]",
                "Security!*[System[(EventID=1102) or (EventID=1107) or (EventID=1108) or (EventID=4608) or (EventID=4610) or (EventID=4611) or (EventID=4614) or (EventID=4622) or (EventID=4624) or (EventID=4625) or (EventID=4634) or (EventID=4647) or (EventID=4648) or (EventID=4649) or (EventID=4657)]]",
                "Security!*[System[(EventID=4661) or (EventID=4662) or (EventID=4663) or (EventID=4665) or (EventID=4666) or (EventID=4667) or (EventID=4688) or (EventID=4670) or (EventID=4672) or (EventID=4673) or (EventID=4674) or (EventID=4675) or (EventID=4689) or (EventID=4697) or (EventID=4700)]]",
                "Security!*[System[(EventID=4702) or (EventID=4704) or (EventID=4705) or (EventID=4716) or (EventID=4717) or (EventID=4718) or (EventID=4719) or (EventID=4720) or (EventID=4722) or (EventID=4723) or (EventID=4724) or (EventID=4725) or (EventID=4726) or (EventID=4727) or (EventID=4728)]]",
                "Security!*[System[(EventID=4729) or (EventID=4733) or (EventID=4732) or (EventID=4735) or (EventID=4737) or (EventID=4738) or (EventID=4739) or (EventID=4740) or (EventID=4742) or (EventID=4744) or (EventID=4745) or (EventID=4746) or (EventID=4750) or (EventID=4751) or (EventID=4752)]]",
                "Security!*[System[(EventID=4754) or (EventID=4755) or (EventID=4756) or (EventID=4757) or (EventID=4760) or (EventID=4761) or (EventID=4762) or (EventID=4764) or (EventID=4767) or (EventID=4768) or (EventID=4771) or (EventID=4774) or (EventID=4778) or (EventID=4779) or (EventID=4781)]]",
                "Security!*[System[(EventID=4793) or (EventID=4797) or (EventID=4798) or (EventID=4799) or (EventID=4800) or (EventID=4801) or (EventID=4802) or (EventID=4803) or (EventID=4825) or (EventID=4826) or (EventID=4870) or (EventID=4886) or (EventID=4887) or (EventID=4888) or (EventID=4893)]]",
                "Security!*[System[(EventID=4898) or (EventID=4902) or (EventID=4904) or (EventID=4905) or (EventID=4907) or (EventID=4931) or (EventID=4932) or (EventID=4933) or (EventID=4946) or (EventID=4948) or (EventID=4956) or (EventID=4985) or (EventID=5024) or (EventID=5033) or (EventID=5059)]]",
                "Security!*[System[(EventID=5136) or (EventID=5137) or (EventID=5140) or (EventID=5145) or (EventID=5632) or (EventID=6144) or (EventID=6145) or (EventID=6272) or (EventID=6273) or (EventID=6278) or (EventID=6416) or (EventID=6423) or (EventID=6424) or (EventID=8001) or (EventID=8002)]]",
                "Security!*[System[(EventID=8003) or (EventID=8004) or (EventID=8005) or (EventID=8006) or (EventID=8007) or (EventID=8222) or (EventID=26401) or (EventID=30004)]]",
                "Microsoft-Windows-AppLocker/EXE and DLL!*[System[(EventID=8001) or (EventID=8002) or (EventID=8003) or (EventID=8004)]]",
                "Microsoft-Windows-AppLocker/MSI and Script!*[System[(EventID=8005) or (EventID=8006) or (EventID=8007)]]"
              ]
            }
          ]
        },
        "destinations": {
          "logAnalytics": [
            {
              "name": "SecurityEvent",
              "workspaceResourceId": "[variables('workspaceResourceId')]"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": [
              "Microsoft-SecurityEvent"
            ],
            "destinations": [
              "SecurityEvent"
            ]
          }
        ]
      }
    },
    {
      "condition": "[parameters('deploySystemAppDcr')]",
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2022-06-01",
      "name": "[variables('effectiveSystemAppDcrName')]",
      "location": "[parameters('location')]",
      "kind": "Windows",
      "tags": {
        "createdBy": "DCR-Deployment"
      },
      "properties": {
        "streamDeclarations": {},
        "dataSources": {
          "windowsEventLogs": [
            {
              "streams": [
                "Microsoft-Event"
              ],
              "xPathQueries": [
                "Application!*[System[(Level=1 or Level=2 or Level=3 or Level=4 or Level=0)]]",
                "System!*[System[(Level=1 or Level=2 or Level=3 or Level=4 or Level=0)]]"
              ],
              "name": "eventLogsDataSource"
            }
          ]
        },
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "[variables('workspaceResourceId')]",
              "name": "SystemAppLogs"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": [
              "Microsoft-Event"
            ],
            "destinations": [
              "SystemAppLogs"
            ],
            "transformKql": "source",
            "outputStream": "Microsoft-Event"
          }
        ]
      }
    },
    {
      "condition": "[parameters('deploySyslogDcr')]",
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2022-06-01",
      "name": "[variables('effectiveSyslogDcrName')]",
      "location": "[parameters('location')]",
      "kind": "Linux",
      "tags": {
        "createdBy": "DCR-Deployment"
      },
      "properties": {
        "streamDeclarations": {},
        "dataSources": {
          "syslog": [
            {
              "streams": [
                "Microsoft-Syslog"
              ],
              "facilityNames": [
                "alert",
                "audit",
                "auth",
                "authpriv",
                "clock",
                "cron",
                "daemon",
                "ftp",
                "kern",
                "local0",
                "local1",
                "local2",
                "local3",
                "local4",
                "local5",
                "local6",
                "local7",
                "lpr",
                "mail",
                "news",
                "nopri",
                "ntp",
                "syslog",
                "user",
                "uucp"
              ],
              "logLevels": [
                "Info",
                "Notice",
                "Warning",
                "Error",
                "Critical",
                "Alert",
                "Emergency"
              ],
              "name": "sysLogsDataSource"
            }
          ]
        },
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "[variables('workspaceResourceId')]",
              "name": "Syslog"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": [
              "Microsoft-Syslog"
            ],
            "destinations": [
              "Syslog"
            ],
            "transformKql": "source | where ProcessName != 'CEF'",
            "outputStream": "Microsoft-Syslog"
          }
        ]
      }
    },
    {
      "condition": "[parameters('deployCefDcr')]",
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2022-06-01",
      "name": "[variables('effectiveCefDcrName')]",
      "location": "[parameters('location')]",
      "kind": "Linux",
      "tags": {
        "createdBy": "DCR-Deployment"
      },
      "properties": {
        "dataSources": {
          "syslog": [
            {
              "streams": [
                "Microsoft-CommonSecurityLog"
              ],
              "facilityNames": [
                "local0",
                "local1",
                "local2",
                "local3",
                "local4",
                "local5",
                "local6",
                "local7"
              ],
              "logLevels": [
                "Info",
                "Notice",
                "Warning",
                "Error",
                "Critical",
                "Alert",
                "Emergency"
              ],
              "name": "sysLogsDataSource-CEF"
            },
            {
              "streams": [
                "Microsoft-CommonSecurityLog"
              ],
              "facilityNames": [
                "nopri"
              ],
              "logLevels": [
                "Emergency"
              ],
              "name": "sysLogsDataSource-CEF-nopri"
            }
          ]
        },
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "[variables('workspaceResourceId')]",
              "name": "DataCollectionEvent"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": [
              "Microsoft-CommonSecurityLog"
            ],
            "destinations": [
              "DataCollectionEvent"
            ],
            "transformKql": "source"
          }
        ]
      }
    },
    {
      "condition": "[parameters('deployCiscoDcr')]",
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2023-03-11",
      "name": "[variables('effectiveCiscoDcrName')]",
      "location": "[parameters('location')]",
      "kind": "Linux",
      "tags": {
        "createdBy": "DCR-Deployment"
      },
      "properties": {
        "dataSources": {
          "syslog": [
            {
              "streams": [
                "Microsoft-CiscoAsa"
              ],
              "facilityNames": [
                "local0",
                "local1",
                "local2",
                "local3",
                "local4",
                "local5",
                "local6",
                "local7"
              ],
              "logLevels": [
                "Info",
                "Notice",
                "Warning",
                "Error",
                "Critical",
                "Alert",
                "Emergency"
              ],
              "name": "sysLogsDataSource-CiscoAsa"
            },
            {
              "streams": [
                "Microsoft-CiscoAsa"
              ],
              "facilityNames": [
                "nopri"
              ],
              "logLevels": [
                "Emergency"
              ],
              "name": "sysLogs-CiscoAsa-nopri"
            }
          ]
        },
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "[variables('workspaceResourceId')]",
              "name": "DataCollectionEvent"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": [
              "Microsoft-CiscoAsa"
            ],
            "destinations": [
              "DataCollectionEvent"
            ]
          }
        ]
      }
    },
    {
      "condition": "[parameters('deployManagedSyslogDcr')]",
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2022-06-01",
      "name": "[variables('effectiveManagedSyslogDcrName')]",
      "location": "[parameters('location')]",
      "kind": "Linux",
      "tags": {
        "createdBy": "DCR-Deployment"
      },
      "properties": {
        "dataSources": {
          "syslog": [
            {
              "streams": [
                "Microsoft-Syslog"
              ],
              "facilityNames": [
                "alert",
                "audit",
                "auth",
                "authpriv",
                "cron",
                "daemon",
                "clock",
                "ftp",
                "kern",
                "local0",
                "local1",
                "local2",
                "local3",
                "local4",
                "local5",
                "local6",
                "local7",
                "lpr",
                "mail",
                "ntp",
                "syslog",
                "user"
              ],
              "logLevels": [
                "Info",
                "Notice",
                "Warning",
                "Error",
                "Critical",
                "Alert",
                "Emergency"
              ],
              "name": "sysLogs-Mgd"
            },
            {
              "streams": [
                "Microsoft-Syslog"
              ],
              "facilityNames": [
                "nopri"
              ],
              "logLevels": [
                "Emergency"
              ],
              "name": "sysLogs-Mgd-nopri"
            }
          ]
        },
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "[variables('workspaceResourceId')]",
              "name": "DataCollectionEvent"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": [
              "Microsoft-Syslog"
            ],
            "destinations": [
              "DataCollectionEvent"
            ],
            "transformKql": "source",
            "outputStream": "Microsoft-Syslog"
          }
        ]
      }
    },
    {
      "condition": "[parameters('deployManagedCefDcr')]",
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2022-06-01",
      "name": "[variables('effectiveManagedCefDcrName')]",
      "location": "[parameters('location')]",
      "kind": "Linux",
      "tags": {
        "createdBy": "DCR-Deployment"
      },
      "properties": {
        "dataSources": {
          "syslog": [
            {
              "streams": [
                "Microsoft-CommonSecurityLog"
              ],
              "facilityNames": [
                "news"
              ],
              "logLevels": [
                "Info",
                "Notice",
                "Warning",
                "Error",
                "Critical",
                "Alert",
                "Emergency"
              ],
              "name": "sysLogs-MgdCEF"
            },
            {
              "streams": [
                "Microsoft-CommonSecurityLog"
              ],
              "facilityNames": [
                "nopri"
              ],
              "logLevels": [
                "Emergency"
              ],
              "name": "sysLogs-MgdCEF-nopri"
            }
          ]
        },
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "[variables('workspaceResourceId')]",
              "name": "DataCollectionEvent"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": [
              "Microsoft-CommonSecurityLog"
            ],
            "destinations": [
              "DataCollectionEvent"
            ],
            "transformKql": "source"
          }
        ]
      }
    },
    {
      "condition": "[parameters('deployManagedCiscoDcr')]",
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2023-03-11",
      "name": "[variables('effectiveManagedCiscoDcrName')]",
      "location": "[parameters('location')]",
      "kind": "Linux",
      "tags": {
        "createdBy": "DCR-Deployment"
      },
      "properties": {
        "dataSources": {
          "syslog": [
            {
              "streams": [
                "Microsoft-CiscoAsa"
              ],
              "facilityNames": [
                "uucp"
              ],
              "logLevels": [
                "Info",
                "Notice",
                "Warning",
                "Error",
                "Critical",
                "Alert",
                "Emergency"
              ],
              "name": "sysLogs-MgdCiscoAsa"
            },
            {
              "streams": [
                "Microsoft-CiscoAsa"
              ],
              "facilityNames": [
                "nopri"
              ],
              "logLevels": [
                "Emergency"
              ],
              "name": "sysLogs-MgdCisco-nopri"
            }
          ]
        },
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "[variables('workspaceResourceId')]",
              "name": "DataCollectionEvent"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": [
              "Microsoft-CiscoAsa"
            ],
            "destinations": [
              "DataCollectionEvent"
            ]
          }
        ]
      }
    }
  ],
  "outputs": {
    "windowsDcrDeployed": {
      "type": "bool",
      "value": "[parameters('deployWindowsDcr')]"
    },
    "windowsDcrName": {
      "type": "string",
      "value": "[if(parameters('deployWindowsDcr'), variables('effectiveWindowsDcrName'), '')]"
    },
    "systemAppDcrDeployed": {
      "type": "bool",
      "value": "[parameters('deploySystemAppDcr')]"
    },
    "systemAppDcrName": {
      "type": "string",
      "value": "[if(parameters('deploySystemAppDcr'), variables('effectiveSystemAppDcrName'), '')]"
    },
    "syslogDcrDeployed": {
      "type": "bool",
      "value": "[parameters('deploySyslogDcr')]"
    },
    "syslogDcrName": {
      "type": "string",
      "value": "[if(parameters('deploySyslogDcr'), variables('effectiveSyslogDcrName'), '')]"
    },
    "cefDcrDeployed": {
      "type": "bool",
      "value": "[parameters('deployCefDcr')]"
    },
    "cefDcrName": {
      "type": "string",
      "value": "[if(parameters('deployCefDcr'), variables('effectiveCefDcrName'), '')]"
    },
    "ciscoDcrDeployed": {
      "type": "bool",
      "value": "[parameters('deployCiscoDcr')]"
    },
    "ciscoDcrName": {
      "type": "string",
      "value": "[if(parameters('deployCiscoDcr'), variables('effectiveCiscoDcrName'), '')]"
    },
    "managedSyslogDcrDeployed": {
      "type": "bool",
      "value": "[parameters('deployManagedSyslogDcr')]"
    },
    "managedSyslogDcrName": {
      "type": "string",
      "value": "[if(parameters('deployManagedSyslogDcr'), variables('effectiveManagedSyslogDcrName'), '')]"
    },
    "managedCefDcrDeployed": {
      "type": "bool",
      "value": "[parameters('deployManagedCefDcr')]"
    },
    "managedCefDcrName": {
      "type": "string",
      "value": "[if(parameters('deployManagedCefDcr'), variables('effectiveManagedCefDcrName'), '')]"
    },
    "managedCiscoDcrDeployed": {
      "type": "bool",
      "value": "[parameters('deployManagedCiscoDcr')]"
    },
    "managedCiscoDcrName": {
      "type": "string",
      "value": "[if(parameters('deployManagedCiscoDcr'), variables('effectiveManagedCiscoDcrName'), '')]"
    }
  }
}
